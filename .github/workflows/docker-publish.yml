# ============================================
# TeleDigest Docker é•œåƒè‡ªåŠ¨æ„å»º & æ¨é€
# è€ç‹å‡ºå“ï¼ŒGitHub Actions è‡ªåŠ¨åŒ–æµæ°´çº¿
# ============================================
#
# è§¦å‘æ¡ä»¶ï¼š
#   1. æ¨é€åˆ° master/main åˆ†æ”¯
#   2. åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾ (v*.*.*)
#   3. æ‰‹åŠ¨è§¦å‘
#
# ä½¿ç”¨å‰éœ€è¦åœ¨ GitHub ä»“åº“è®¾ç½® Secretsï¼š
#   - DOCKERHUB_USERNAME: Docker Hub ç”¨æˆ·å
#   - DOCKERHUB_TOKEN: Docker Hub Access Token
# ============================================

name: Build and Push Docker Image

on:
  push:
    branches:
      - master
      - main
    tags:
      - 'v*.*.*'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      tag:
        description: 'é•œåƒæ ‡ç­¾ (ç•™ç©ºåˆ™ä½¿ç”¨ latest)'
        required: false
        default: 'latest'

env:
  # Docker Hub é•œåƒåç§°ï¼ˆä¼šè‡ªåŠ¨åŠ ä¸Šç”¨æˆ·åå‰ç¼€ï¼‰
  IMAGE_NAME: teledigest-bot

jobs:
  build-and-push:
    name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ‹‰å–ä»£ç 
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      # ç¬¬äºŒæ­¥ï¼šè®¾ç½® QEMUï¼ˆç”¨äºå¤šå¹³å°æ„å»ºï¼‰
      - name: ğŸ”§ è®¾ç½® QEMU
        uses: docker/setup-qemu-action@v3

      # ç¬¬ä¸‰æ­¥ï¼šè®¾ç½® Docker Buildx
      - name: ğŸ”§ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ç¬¬å››æ­¥ï¼šç™»å½• Docker Hub
      - name: ğŸ” ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ç¬¬äº”æ­¥ï¼šæå–å…ƒæ•°æ®ï¼ˆæ ‡ç­¾ã€ç‰ˆæœ¬ç­‰ï¼‰
      - name: ğŸ“‹ æå– Docker å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}
          tags: |
            # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥çš„æ ‡ç­¾
            type=raw,value=${{ github.event.inputs.tag }},enable=${{ github.event_name == 'workflow_dispatch' }}
            # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶æ‰“ latest æ ‡ç­¾
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' }}
            # ç‰ˆæœ¬æ ‡ç­¾ v1.0.0 -> 1.0.0
            type=semver,pattern={{version}}
            # ç‰ˆæœ¬æ ‡ç­¾ v1.0.0 -> 1.0
            type=semver,pattern={{major}}.{{minor}}
            # Git SHA çŸ­æ ‡ç­¾
            type=sha,prefix=sha-

      # ç¬¬å…­æ­¥ï¼šæ„å»ºå¹¶æ¨é€é•œåƒ
      - name: ğŸš€ æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          # å¤šå¹³å°æ„å»ºï¼šæ”¯æŒ AMD64 å’Œ ARM64
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # ç¼“å­˜é…ç½®ï¼ŒåŠ é€Ÿæ„å»º
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ç¬¬ä¸ƒæ­¥ï¼šè¾“å‡ºé•œåƒä¿¡æ¯
      - name: ğŸ“¦ è¾“å‡ºé•œåƒä¿¡æ¯
        run: |
          echo "============================================"
          echo "âœ… è€ç‹çš„é•œåƒæ„å»ºå®Œæˆï¼"
          echo "============================================"
          echo ""
          echo "ğŸ“¦ é•œåƒæ ‡ç­¾ï¼š"
          echo "${{ steps.meta.outputs.tags }}"
          echo ""
          echo "ğŸš€ åœ¨ Claw.cloud ä½¿ç”¨ï¼š"
          echo "   ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
          echo "============================================"
